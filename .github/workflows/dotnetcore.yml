name: .NET Core

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.100
    - name: SonarScanner TypeScript Download
      run: curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.2.0.1873-linux.zip  
    - name: SonarScanner TypeScript Unzip              
      run:  unzip $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
    - name: SonarScanner TypeScript List
      run: ls $HOME/.sonar/      
    - name: SonarScanner TypeScript Run              
      run: $HOME/.sonar/sonar-scanner-4.2.0.1873-linux/sonar-scanner -Dsonar.organization=marsen-github -Dsonar.projectKey=Marsen.NetCore.Dojo.TypeScript -Dsonar.sources=. -Dsonar.host.url=https://sonarcloud.io -Dsonar.login=bdc631931013cbd512c1437dedbaf4be86ade6bf
    - name: Install Dotnet Stryker
      run: dotnet tool install --global dotnet-stryker
    - name: Install Dotnet Sonarscanner	
      run: dotnet tool install --global dotnet-sonarscanner  
    - uses: actions/checkout@master    
    - name: SonarScanner Begin    
      run: dotnet sonarscanner begin /k:"marsen_Marsen.NetCore.Dojo" /o:"marsen-github" /d:"sonar.host.url=https://sonarcloud.io" /d:"sonar.login="$SONAR_LOGIN
    - name: Build with dotnet
      run: dotnet build ".\Marsen.NetCore.Dojo.Integration.Test.sln"   
    - name: UnitTest Result
      run: dotnet test ./test/Marsen.NetCore.Dojo.Tests/Marsen.NetCore.Dojo.Tests.csproj --logger:trx;LogFileName=result.trx
    - name: UnitTest Coverage
      run: dotnet test ./test/Marsen.NetCore.Dojo.Tests/Marsen.NetCore.Dojo.Tests.csproj --collect:"XPlat Code Coverage" --settings .coverlet       
    - name: Integration Test with dotnet
      run: dotnet test ./test/Marsen.NetCore.Dojo.Integration.Tests/Marsen.NetCore.Dojo.Integration.Tests.csproj --logger:trx;LogFileName=result.trx 
    - name: SonarScanner End
      run: dotnet sonarscanner end /d:"sonar.login="$SONAR_LOGIN 
    - name: Dotnet Stryker
      run: dotnet stryker -tp "['./test/Marsen.NetCore.Dojo.Tests/Marsen.NetCore.Dojo.Tests.csproj','./test/Marsen.NetCore.Dojo.Integration.Tests/Marsen.NetCore.Dojo.Integration.Tests.csproj']" -p="Marsen.NetCore.Dojo.csproj" -dk=$STRYKER_DASHBOARD_API_KEY
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      SONAR_LOGIN: ${{ secrets.SONAR_LOGIN }}
      STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }} 
